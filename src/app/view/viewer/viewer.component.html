<nav class="tool-bar">
	<ul>
		<li
			(click)="execFunc('color-picker')"
			[ngClass]="{
				active: (memory.reservedByFunc$ | async)?.current.name === 'color-picker',
				disable: !(memory.isLoaded$ | async)
			}"
			class="icon-prefix name-info-wrapper"
		>
			<fa-icon [icon]="faEyeDropper" [fixedWidth]="true" size="lg"></fa-icon>
			<div class="name-info-column">スポイト</div>
		</li>
		<li
			(click)="execFunc('crop')"
			[ngClass]="{
				active: (memory.reservedByFunc$ | async)?.current.name === 'crop',
				disable: !(memory.isLoaded$ | async)
			}"
			class="icon-prefix name-info-wrapper"
		>
			<fa-icon [icon]="faCropAlt" [fixedWidth]="true" size="lg"></fa-icon>
			<div class="name-info-column">クロッピング</div>
		</li>
		<li
			(click)="execFunc('zoom')"
			[ngClass]="{
				active: (memory.reservedByFunc$ | async)?.current.name === 'zoom',
				disable: !(memory.isLoaded$ | async)
			}"
			class="icon-prefix name-info-wrapper"
		>
			<fa-icon [icon]="faSearch" [fixedWidth]="true" size="lg" style="transform: scale(-1, 1)"></fa-icon>
			<div class="name-info-column">拡大・縮小</div>
		</li>
	</ul>
</nav>

<div (click)="execFunc('garbage')" class="garbage">
	<div [ngClass]="{ disable: !(memory.isLoaded$ | async) }" class="icon-prefix name-info-wrapper">
		<fa-icon [icon]="faTrashAlt" [fixedWidth]="true" size="lg" style="transform: scale(-1, 1)"></fa-icon>
		<div class="name-info-column">ゴミ箱</div>
	</div>
</div>

<div class="container">
	<header>
		<h1>
			<a href="./">
				<fa-icon [icon]="faEye" [fixedWidth]="true" size="sm"></fa-icon>
				SeekPSD
			</a>
		</h1>
	</header>

	<div class="flex-left-right">
		<div #psdViewer class="psd-viewer">
			<div #dropArea (click)="loadFile()" appFileEvent (fileDropped)="onFileDropped($event)" class="drop-area active">
				<div class="normal">
					<fa-icon [icon]="faFileImage" size="3x"></fa-icon>
					<h3>PSDファイルを開く</h3>
					<p>ここにファイルをドラッグ＆ドロップ</p>
				</div>
				<div class="hover">
					<fa-icon [icon]="faDownload" size="3x"></fa-icon>
				</div>
				<div *ngIf="isLoading" class="hover active">
					<div class="loader">
						<div class="bar1"></div>
						<div class="bar2"></div>
						<div class="bar3"></div>
						<div class="bar4"></div>
						<div class="bar5"></div>
						<div class="bar6"></div>
					</div>
				</div>
			</div>

			<canvas #mainCanvas class="psd-canvas"></canvas>
			<canvas #overlayCanvas class="overlay-canvas"></canvas>

			<div
				*ngIf="(memory.reservedByFunc$ | async)?.current.name === 'crop'"
				[style.top]="(memory.crop$ | async)?.offset.current.y - (memory.crop$ | async)?.size.height / 2 - 10 + 'px'"
				[style.left]="(memory.crop$ | async)?.offset.current.x + 30 + 'px'"
				class="crop-panel"
			>
				<form #formCheck="ngForm" [formGroup]="cropConf" class="form-check">
					<input type="text" [formControl]="cropConf.controls['width']" />
					<span>×</span>
					<input type="text" [formControl]="cropConf.controls['height']" />
					<div class="icon-prefix name-info-wrapper">
						<fa-icon [icon]="faUnlock" [fixedWidth]="true" size="sm"></fa-icon>
						<div class="name-info-row">アスペクト比の固定</div>
					</div>
					<div class="icon-prefix name-info-wrapper">
						<fa-icon [icon]="faUndo" [fixedWidth]="true" size="sm" style="transform: scale(-1, 1)"></fa-icon>
						<div class="name-info-row">回転</div>
					</div>
					<input type="button" value="切り取り" (click)="crop()" />
				</form>
			</div>

			<!-- <div [style.top]="100 + 'px'" [style.left]="500 + 'px'" class="crop-panel">
				<form #formCheck="ngForm" [formGroup]="cropConf" class="form-check">
					<input type="text" [formControl]="cropConf.controls['width']" />
					<span>×</span>
					<input type="text" [formControl]="cropConf.controls['height']" />
					<div class="lock-icon">
						<fa-icon [icon]="faUnlock" [fixedWidth]="true" size="sm"></fa-icon>
					</div>
					<input type="button" value="切り取り" (click)="crop()" />
				</form>
			</div> -->

			<div
				[style.top]="100 + 'px'"
				[style.left]="500 + 'px'"
				class="crop-panel"
			>
				<form #formCheck="ngForm" [formGroup]="cropConf" class="form-check">
					<input type="text" [formControl]="cropConf.controls['width']" />
					<span>×</span>
					<input type="text" [formControl]="cropConf.controls['height']" />
					<div class="icon-prefix name-info-wrapper">
						<fa-icon [icon]="faUnlock" [fixedWidth]="true" size="sm"></fa-icon>
						<div class="name-info-row">アスペクト比の固定</div>
					</div>
					<div class="icon-prefix name-info-wrapper">
						<fa-icon [icon]="faUndo" [fixedWidth]="true" size="sm" style="transform: scale(-1, 1)"></fa-icon>
						<div class="name-info-row">回転</div>
					</div>
					<input type="button" value="切り取り" (click)="crop()" />
				</form>
			</div>
		</div>

		<div class="layer-info">
			<h2>
				<fa-icon [icon]="faSignature" [fixedWidth]="true" size="sm"></fa-icon>
				{{ memory.fileName$ | async }}
			</h2>

			<div class="outer-layer-panel">
				<nav class="layer-panel">
					<ul>
						<ng-template #recursiveList let-list>
							<li *ngFor="let item of list; let i = index" style="position: relative">
								<div class="eye-icon" (click)="toggleVisibility(item.name, item.uniqueId)">
									<fa-icon *ngIf="!item.hidden.current" [icon]="faEye" [fixedWidth]="true" size="sm"></fa-icon>
									<fa-icon *ngIf="item.hidden.current" [icon]="faEyeSlash" [fixedWidth]="true" size="sm"></fa-icon>
								</div>

								<input attr.id="{{ item.name + '_seek_psd_' + item.uniqueId + '_' + i }}" type="checkbox" hidden />
								<label
									attr.for="{{ item.name + '_seek_psd_' + item.uniqueId + '_' + i }}"
									appPreventHoverPropagation
									class="ellipsis"
								>
									<div class="arrow-icon">
										<fa-icon
											*ngIf="item.children.length > 0"
											[icon]="faAngleRight"
											[fixedWidth]="true"
											size="sm"
										></fa-icon>
									</div>
									<fa-icon *ngIf="item.children.length > 0" [icon]="faFolder" [fixedWidth]="true" size="sm"></fa-icon>
									{{ item.name }}
								</label>
								<ul *ngIf="item.children.length > 0" class="ul-prefix sub-group-list">
									<ng-container *ngTemplateOutlet="recursiveList; context: { $implicit: item.children }"></ng-container>
								</ul>
							</li>
						</ng-template>
						<div *ngIf="memory.layerInfos$ | async; $implicit as list">
							<ng-container *ngTemplateOutlet="recursiveList; context: { $implicit: list }"></ng-container>
						</div>
					</ul>
				</nav>
			</div>
		</div>
	</div>
</div>

<footer>
	<div class="wrapper">
		<span>©NkiHrk</span>
		<span>・</span>
		<a href="https://github.com/nkihrk" target="_blank">GitHub</a>
		<span>・</span>
		<a href="https://github.com/nkihrk/seek-psd" target="_blank">About SeekPSD</a>
	</div>
</footer>

<div #screenCanvasWrapper appPointerEvent (pointerData)="onPointerEvent($event)" class="color-picker-wrapper">
	<canvas #screenCanvas></canvas>
</div>
